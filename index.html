function doGet(e) {
  if (e.parameter.type) {
    return handleRequest(e.parameter);
  }
  return ContentService.createTextOutput(JSON.stringify({status: 'ok'}))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    return handleRequest(data);
  } catch(err) {
    return ContentService.createTextOutput(JSON.stringify({success: false, error: err.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function handleRequest(data) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var result = {};
  
  switch(data.type) {
    case 'mileage':
      result = addMileage(ss, data);
      break;
    case 'gas':
      result = addGas(ss, data);
      break;
    case 'expense':
      result = addExpense(ss, data);
      break;
    case 'allergy':
      result = addAllergy(ss, data);
      break;
    default:
      result = {success: false, error: 'Unknown type'};
  }
  
  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

function findFirstEmptyRow(sheet) {
  var dates = sheet.getRange('A:A').getValues();
  for (var i = 1; i < dates.length; i++) {
    if (dates[i][0] === '' || dates[i][0] === null) {
      return i + 1;
    }
  }
  return dates.length + 1;
}

function addMileage(ss, data) {
  var sheet = ss.getSheetByName('Mileage');
  var newRow = findFirstEmptyRow(sheet);
  
  sheet.getRange(newRow, 1).setValue(data.date || new Date());
  sheet.getRange(newRow, 3).setValue(data.finish);
  sheet.getRange(newRow, 4).setValue(data.from || '');
  sheet.getRange(newRow, 5).setValue(data.to || '');
  sheet.getRange(newRow, 7).setValue(data.wp);
  
  return {success: true, message: 'Mileage added', row: newRow};
}

function addGas(ss, data) {
  var sheet = ss.getSheetByName('Gas');
  var newRow = findFirstEmptyRow(sheet);
  
  sheet.getRange(newRow, 1).setValue(data.date || new Date());
  sheet.getRange(newRow, 2).setValue(data.odometer);
  sheet.getRange(newRow, 3).setValue(data.liters);
  sheet.getRange(newRow, 4).setValue(data.price);
  
  return {success: true, message: 'Gas added', row: newRow};
}

function addExpense(ss, data) {
  var sheet = ss.getSheetByName('Expenses');
  var newRow = findFirstEmptyRow(sheet);
  
  sheet.getRange(newRow, 1).setValue(data.date || new Date());
  sheet.getRange(newRow, 2).setValue(data.amount);
  sheet.getRange(newRow, 3).setValue(data.vendor || '');
  sheet.getRange(newRow, 4).setValue(data.description || '');
  sheet.getRange(newRow, 5).setValue(data.category);
  sheet.getRange(newRow, 6).setValue(data.corpPersonal);
  sheet.getRange(newRow, 7).setValue(data.paidOn);
  
  return {success: true, message: 'Expense added', row: newRow};
}

function addAllergy(ss, data) {
  var sheet = ss.getSheetByName('Allergy Shots');
  var newRow = findFirstEmptyRow(sheet);
  
  sheet.getRange(newRow, 1).setValue(data.date || new Date());
  sheet.getRange(newRow, 2).setValue(data.right);
  sheet.getRange(newRow, 3).setValue(data.left);
  sheet.getRange(newRow, 4).setValue(data.notes || '');
  
  return {success: true, message: 'Allergy shot added', row: newRow};
}

function testScript() {
  Logger.log('Script is working!');
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  Logger.log('Spreadsheet name: ' + ss.getName());
  Logger.log('Sheets: ' + ss.getSheets().map(function(s) { return s.getName(); }).join(', '));
}

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Expense Tracker</title>
<style type="text/css">
body { font-family: -apple-system, sans-serif; background: #1a1a2e; margin: 0; padding: 20px; min-height: 100vh; box-sizing: border-box; }
h1 { color: white; text-align: center; font-size: 22px; margin-bottom: 20px; }
.config { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; }
.config label { color: white; font-size: 12px; display: block; margin-bottom: 5px; }
.config input { width: 100%; padding: 10px; border: none; border-radius: 5px; font-size: 14px; box-sizing: border-box; }
.config button { margin-top: 10px; padding: 10px 20px; background: #4facfe; color: white; border: none; border-radius: 5px; font-size: 14px; }
.buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
.btn { padding: 25px 15px; font-size: 16px; font-weight: bold; border: none; border-radius: 15px; color: white; text-align: center; }
.btn-mileage { background: #667eea; }
.btn-gas { background: #f5576c; }
.btn-expense { background: #4facfe; }
.btn-allergy { background: #43e97b; }
.btn span { display: block; }
.btn .icon { font-size: 28px; margin-bottom: 8px; }
.btn-stop { background: #ff4757; padding: 20px; font-size: 18px; margin-top: 20px; width: 100%; border: none; border-radius: 15px; color: white; font-weight: bold; }
.btn-correct { background: #ffa502; padding: 12px 20px; font-size: 14px; margin-top: 10px; border: none; border-radius: 10px; color: white; font-weight: bold; }
.recording-label { color: #ff4757; text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 10px; }
.status { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; color: white; min-height: 80px; }
.status-label { font-size: 11px; opacity: 0.7; margin-bottom: 8px; }
.status-text { font-size: 14px; }
.hidden { display: none; }
.disabled { opacity: 0.4; pointer-events: none; }
.overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); justify-content: center; align-items: center; z-index: 100; }
.overlay.active { display: flex; }
.popup { background: #1a1a2e; padding: 25px; border-radius: 15px; text-align: center; margin: 20px; max-width: 350px; width: 90%; }
.popup h2 { color: white; margin: 0 0 20px 0; font-size: 18px; }
.popup button { padding: 15px 30px; margin: 5px; font-size: 16px; font-weight: bold; border: none; border-radius: 10px; color: white; min-width: 100px; }
.popup .btn1 { background: #4facfe; }
.popup .btn2 { background: #f5576c; }
.popup .btn-save { background: #43e97b; width: 100%; margin-top: 15px; }
.popup .btn-cancel { background: #666; width: 100%; margin-top: 10px; }
.edit-field { margin-bottom: 15px; text-align: left; }
.edit-field label { color: #aaa; font-size: 12px; display: block; margin-bottom: 5px; }
.edit-field input, .edit-field select { width: 100%; padding: 10px; border: none; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
.success { color: #43e97b; }
.error { color: #f5576c; }
</style>
</head>
<body>

<h1>üìä Expense Tracker</h1>

<div class="config" id="configSection">
<label>Google Apps Script URL:</label>
<input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/...">
<button onclick="saveConfig()">Save & Hide</button>
</div>

<div class="buttons" id="mainButtons">
<button class="btn btn-mileage" onclick="startEntry('mileage')">
<span class="icon">üöó</span>
<span>Mileage</span>
</button>
<button class="btn btn-gas" onclick="startEntry('gas')">
<span class="icon">‚õΩ</span>
<span>Gas</span>
</button>
<button class="btn btn-expense" onclick="startEntry('expense')">
<span class="icon">üí≥</span>
<span>Expense</span>
</button>
<button class="btn btn-allergy" onclick="startEntry('allergy')">
<span class="icon">üíâ</span>
<span>Allergy</span>
</button>
</div>

<div class="recording-label hidden" id="recordingLabel">üî¥ Recording: MILEAGE</div>

<div class="status">
<div class="status-label">Status</div>
<div class="status-text" id="statusText">Tap a button to start</div>
</div>

<button class="btn btn-stop hidden" id="stopButton" onclick="stopListening()">
üõë Tap When Done Speaking
</button>

<button class="btn btn-correct hidden" id="correctButton" onclick="showCorrectForm()">
‚úèÔ∏è Correct Entry
</button>

<div class="overlay" id="wpPrompt">
<div class="popup">
<h2>Work or Personal?</h2>
<button class="btn1" onclick="selectWP('Work')">Work</button>
<button class="btn2" onclick="selectWP('Personal')">Personal</button>
</div>
</div>

<div class="overlay" id="corpPrompt">
<div class="popup">
<h2>Corp or Personal?</h2>
<button class="btn1" onclick="selectCorp('Corp')">Corp</button>
<button class="btn2" onclick="selectCorp('Personal')">Personal</button>
</div>
</div>

<div class="overlay" id="editPrompt">
<div class="popup">
<h2 id="editTitle">Edit Entry</h2>
<div id="editFields"></div>
<button class="btn-save" onclick="saveCorrection()">Save Changes</button>
<button class="btn-cancel" onclick="cancelCorrection()">Cancel</button>
</div>
</div>

<script>
var recognition;
var currentType = null;
var pendingData = {};
var lastSavedData = {};
var lastSavedRow = null;
var lastSavedSheet = null;
var spokenText = '';

var categoryKeywords = {
'parking': 'Parking',
'repair': 'Repairs & Maintenance',
'repairs': 'Repairs & Maintenance',
'maintenance': 'Repairs & Maintenance',
'car wash': 'Auto Wash',
'auto wash': 'Auto Wash',
'wash': 'Auto Wash',
'meals': 'Meals & Entertainment',
'meal': 'Meals & Entertainment',
'dinner': 'Meals & Entertainment',
'lunch': 'Meals & Entertainment',
'breakfast': 'Meals & Entertainment',
'entertainment': 'Meals & Entertainment',
'promotion': 'Promotions/Gifts/Tickets',
'gift': 'Promotions/Gifts/Tickets',
'ticket': 'Promotions/Gifts/Tickets',
'tickets': 'Promotions/Gifts/Tickets',
'office': 'Office/Postage/Stationery',
'postage': 'Office/Postage/Stationery',
'stationery': 'Office/Postage/Stationery',
'hotel': 'Hotels',
'hotels': 'Hotels',
'travel': 'Travel Fares',
'flight': 'Travel Fares',
'airfare': 'Travel Fares',
'fare': 'Travel Fares',
'phone': 'Phone/Internet',
'internet': 'Phone/Internet',
'other business': 'Other Business',
'buh': 'BUH',
'cme': 'CME',
'course': 'CME',
'book': 'CME',
'subscription': 'CME',
'education': 'CME',
'membership': 'License/Membership Fees',
'dues': 'License/Membership Fees',
'license': 'License/Membership Fees',
'non-buh': 'NON-BUH',
'non buh': 'NON-BUH',
'donation': 'Donations',
'donations': 'Donations',
'charitable': 'Donations',
'special': 'Special Expenses',
'fyi': 'FYI'
};

var allCategories = ['Parking', 'Repairs & Maintenance', 'Auto Wash', 'Meals & Entertainment', 'Promotions/Gifts/Tickets', 'Office/Postage/Stationery', 'Hotels', 'Travel Fares', 'Phone/Internet', 'Other Business', 'BUH', 'CME', 'License/Membership Fees', 'NON-BUH', 'Donations', 'Special Expenses', 'FYI'];

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
recognition = new SpeechRecognition();
recognition.continuous = true;
recognition.interimResults = true;
recognition.lang = 'en-US';

recognition.onresult = function(event) {
var text = '';
for (var i = 0; i < event.results.length; i++) {
text += event.results[i][0].transcript;
}
spokenText = text;
updateStatus('üé§ ' + text);
};

recognition.onerror = function(event) {
updateStatus('Error: ' + event.error, true);
showMainButtons();
};
}

window.onload = function() {
var savedUrl = localStorage.getItem('scriptUrl');
if (savedUrl) {
document.getElementById('scriptUrl').value = savedUrl;
document.getElementById('configSection').classList.add('hidden');
}
};

function saveConfig() {
var url = document.getElementById('scriptUrl').value.trim();
if (url) {
localStorage.setItem('scriptUrl', url);
document.getElementById('configSection').classList.add('hidden');
updateStatus('Configuration saved!');
}
}

function updateStatus(text, isError) {
var el = document.getElementById('statusText');
el.textContent = text;
el.className = 'status-text' + (isError ? ' error' : '');
}

function showMainButtons() {
document.getElementById('mainButtons').classList.remove('disabled');
document.getElementById('stopButton').classList.add('hidden');
document.getElementById('recordingLabel').classList.add('hidden');
}

function hideMainButtons() {
document.getElementById('mainButtons').classList.add('disabled');
document.getElementById('stopButton').classList.remove('hidden');
}

function showCorrectButton() {
document.getElementById('correctButton').classList.remove('hidden');
}

function hideCorrectButton() {
document.getElementById('correctButton').classList.add('hidden');
}

function startEntry(type) {
currentType = type;
pendingData = {};
spokenText = '';
hideCorrectButton();
lastSavedRow = null;
lastSavedSheet = null;

var labels = {
mileage: 'üé§ Say: "207608 home to hospital work for conference"',
gas: 'üé§ Say: "45 dollars 52 liters 207500"',
expense: 'üé§ Say: "CME 200 dollars CAEP course"',
allergy: 'üé§ Say: "0.3 both"'
};

var recordLabels = {
mileage: 'üî¥ Recording: MILEAGE',
gas: 'üî¥ Recording: GAS',
expense: 'üî¥ Recording: EXPENSE',
allergy: 'üî¥ Recording: ALLERGY'
};

updateStatus(labels[type]);
document.getElementById('recordingLabel').textContent = recordLabels[type];
document.getElementById('recordingLabel').classList.remove('hidden');
hideMainButtons();

if (recognition) {
try { recognition.start(); } catch(e) {}
} else {
updateStatus('Speech not supported', true);
showMainButtons();
}
}

function stopListening() {
if (recognition) {
try { recognition.stop(); } catch(e) {}
}
showMainButtons();

var transcript = spokenText.trim().toLowerCase();
if (!transcript) {
updateStatus('No speech detected. Try again.', true);
return;
}

updateStatus('Processing: "' + transcript + '"');
processVoiceInput(transcript);
}

function processVoiceInput(transcript) {
if (currentType === 'mileage') parseMileage(transcript);
else if (currentType === 'gas') parseGas(transcript);
else if (currentType === 'expense') parseExpense(transcript);
else if (currentType === 'allergy') parseAllergy(transcript);
}

function formatDate(d) {
var yyyy = d.getFullYear();
var mm = String(d.getMonth() + 1).padStart(2, '0');
var dd = String(d.getDate()).padStart(2, '0');
return yyyy + '-' + mm + '-' + dd;
}

function parseDate(text) {
var today = new Date();
var d = null;

if (text.indexOf('yesterday') !== -1) {
d = new Date();
d.setDate(d.getDate() - 1);
return formatDate(d);
}

var lastDayMatch = text.match(/last\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i);
if (lastDayMatch) {
var days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
var targetDay = days.indexOf(lastDayMatch[1].toLowerCase());
d = new Date();
var currentDay = d.getDay();
var diff = currentDay - targetDay;
if (diff <= 0) diff += 7;
d.setDate(d.getDate() - diff);
return formatDate(d);
}

var months = {
'january': 0, 'jan': 0,
'february': 1, 'feb': 1,
'march': 2, 'mar': 2,
'april': 3, 'apr': 3,
'may': 4,
'june': 5, 'jun': 5,
'july': 6, 'jul': 6,
'august': 7, 'aug': 7,
'september': 8, 'sep': 8, 'sept': 8,
'october': 9, 'oct': 9,
'november': 10, 'nov': 10,
'december': 11, 'dec': 11
};

var monthDayMatch = text.match(/(january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|jun|jul|aug|sep|sept|oct|nov|dec)\s+(\d{1,2})(?:st|nd|rd|th)?/i);
if (monthDayMatch) {
var month = months[monthDayMatch[1].toLowerCase()];
var day = parseInt(monthDayMatch[2]);
var year = today.getFullYear();
d = new Date(year, month, day);
if (d > today) {
d.setFullYear(year - 1);
}
return formatDate(d);
}

return formatDate(today);
}

function parseMileage(text) {
var odometerMatch = text.match(/\b(\d{5,})\b/);
var finish = odometerMatch ? parseInt(odometerMatch[1]) : null;

var cleanText = text.replace(/\b(the|a|an)\b/g, '').replace(/\s+/g, ' ');
var toMatch = cleanText.match(/(?:from\s+)?(\w+)\s+to\s+(\w+)/i);
var from = toMatch ? toMatch[1] : '';
var to = toMatch ? toMatch[2] : '';

var wp = null;
if (text.indexOf('work') !== -1 || text.indexOf('corp') !== -1 || text.indexOf('corporate') !== -1) wp = 'Work';
else if (text.indexOf('personal') !== -1) wp = 'Personal';

var date = parseDate(text);

var description = '';
var forMatch = text.match(/\bfor\s+(.+)$/i);
if (forMatch) {
description = forMatch[1]
.replace(/\bwork\b/gi, '')
.replace(/\bpersonal\b/gi, '')
.replace(/\bcorp\b/gi, '')
.replace(/\bcorporate\b/gi, '')
.replace(/\b\d{5,}\b/g, '')
.replace(/\s+/g, ' ')
.trim();
}

pendingData = { type: 'mileage', finish: finish, from: from, to: to, wp: wp, date: date, description: description };

if (!finish) {
updateStatus('Could not find odometer. Try again.', true);
return;
}
if (!wp) {
document.getElementById('wpPrompt').classList.add('active');
} else {
submitData(pendingData, false);
}
}

function parseGas(text) {
var priceMatch = text.match(/(\d+(?:\.\d+)?)\s*(?:dollars?|\$)/i);
var price = priceMatch ? parseFloat(priceMatch[1]) : null;

var litersMatch = text.match(/(\d+(?:\.\d+)?)\s*(?:liters?|l\b)/i);
var liters = litersMatch ? parseFloat(litersMatch[1]) : null;

var odometerMatch = text.match(/\b(\d{5,})\b/);
var odometer = odometerMatch ? parseInt(odometerMatch[1]) : null;

var date = parseDate(text);

pendingData = { type: 'gas', price: price, liters: liters, odometer: odometer, date: date };

if (!price || !liters || !odometer) {
updateStatus('Need: price, liters, odometer.', true);
return;
}
submitData(pendingData, false);
}

function parseExpense(text) {
var amountMatch = text.match(/(\d+(?:\.\d+)?)\s*(?:dollars?|\$)/i);
var amount = amountMatch ? parseFloat(amountMatch[1]) : null;

var category = null;
for (var keyword in categoryKeywords) {
if (text.indexOf(keyword) !== -1) {
category = categoryKeywords[keyword];
break;
}
}

var autoPersonal = ['NON-BUH', 'Donations', 'Special Expenses', 'FYI'];
var autoCorp = ['CME', 'License/Membership Fees'];

var corpPersonal = null;
var paidOn = null;

if (autoPersonal.indexOf(category) !== -1) {
corpPersonal = 'Personal';
paidOn = 'Personal Card';
} else if (autoCorp.indexOf(category) !== -1) {
corpPersonal = 'Corp';
paidOn = 'Corp Card';
} else if (text.indexOf('corp on personal') !== -1) {
corpPersonal = 'Corp';
paidOn = 'Personal Card';
} else if (text.indexOf('corp') !== -1 || text.indexOf('corporate') !== -1) {
corpPersonal = 'Corp';
paidOn = 'Corp Card';
} else if (text.indexOf('personal') !== -1) {
corpPersonal = 'Personal';
paidOn = 'Personal Card';
}

var vendor = text.split(/\s+/).slice(0, 2).join(' ');
var date = parseDate(text);

pendingData = { type: 'expense', amount: amount, category: category, corpPersonal: corpPersonal, paidOn: paidOn, vendor: vendor, description: text, date: date };

if (!amount) {
updateStatus('Could not find amount.', true);
return;
}
if (!category) {
updateStatus('Could not find category.', true);
return;
}
if (!corpPersonal) {
document.getElementById('corpPrompt').classList.add('active');
} else {
submitData(pendingData, false);
}
}

function parseAllergy(text) {
var right = null;
var left = null;
var notes = '';

if (text.indexOf('both') !== -1) {
var doseMatch = text.match(/(\d+(?:\.\d+)?)/);
if (doseMatch) {
right = parseFloat(doseMatch[1]);
left = right;
}
} else {
var rightMatch = text.match(/(\d+(?:\.\d+)?)\s*right/i) || text.match(/right\s*(\d+(?:\.\d+)?)/i);
var leftMatch = text.match(/(\d+(?:\.\d+)?)\s*left/i) || text.match(/left\s*(\d+(?:\.\d+)?)/i);
if (rightMatch) right = parseFloat(rightMatch[1]);
if (leftMatch) left = parseFloat(leftMatch[1]);
}

var date = parseDate(text);

pendingData = { type: 'allergy', right: right, left: left, notes: notes, date: date };

if (!right && !left) {
updateStatus('Could not find dose.', true);
return;
}
submitData(pendingData, false);
}

function selectWP(value) {
document.getElementById('wpPrompt').classList.remove('active');
pendingData.wp = value;
submitData(pendingData, false);
}

function selectCorp(value) {
document.getElementById('corpPrompt').classList.remove('active');
pendingData.corpPersonal = value;
pendingData.paidOn = (value === 'Corp') ? 'Corp Card' : 'Personal Card';
submitData(pendingData, false);
}

function showCorrectForm() {
var html = '';
var title = '';

if (lastSavedData.type === 'mileage') {
title = 'Edit Mileage';
html = '<div class="edit-field"><label>Date</label><input type="date" id="editDate" value="' + lastSavedData.date + '"></div>';
html += '<div class="edit-field"><label>Odometer</label><input type="number" id="editOdometer" value="' + lastSavedData.finish + '"></div>';
html += '<div class="edit-field"><label>From</label><input type="text" id="editFrom" value="' + lastSavedData.from + '"></div>';
html += '<div class="edit-field"><label>To</label><input type="text" id="editTo" value="' + lastSavedData.to + '"></div>';
html += '<div class="edit-field"><label>Work/Personal</label><select id="editWP"><option value="Work"' + (lastSavedData.wp === 'Work' ? ' selected' : '') + '>Work</option><option value="Personal"' + (lastSavedData.wp === 'Personal' ? ' selected' : '') + '>Personal</option></select></div>';
html += '<div class="edit-field"><label>Description</label><input type="text" id="editDescription" value="' + (lastSavedData.description || '') + '"></div>';
}
else if (lastSavedData.type === 'gas') {
title = 'Edit Gas';
html = '<div class="edit-field"><label>Date</label><input type="date" id="editDate" value="' + lastSavedData.date + '"></div>';
html += '<div class="edit-field"><label>Odometer</label><input type="number" id="editOdometer" value="' + lastSavedData.odometer + '"></div>';
html += '<div class="edit-field"><label>Liters</label><input type="number" step="0.1" id="editLiters" value="' + lastSavedData.liters + '"></div>';
html += '<div class="edit-field"><label>Price ($)</label><input type="number" step="0.01" id="editPrice" value="' + lastSavedData.price + '"></div>';
}
else if (lastSavedData.type === 'expense') {
title = 'Edit Expense';
html = '<div class="edit-field"><label>Date</label><input type="date" id="editDate" value="' + lastSavedData.date + '"></div>';
html += '<div class="edit-field"><label>Amount ($)</label><input type="number" step="0.01" id="editAmount" value="' + lastSavedData.amount + '"></div>';
html += '<div class="edit-field"><label>Vendor</label><input type="text" id="editVendor" value="' + lastSavedData.vendor + '"></div>';
html += '<div class="edit-field"><label>Category</label><select id="editCategory">';
for (var i = 0; i < allCategories.length; i++) {
html += '<option value="' + allCategories[i] + '"' + (lastSavedData.category === allCategories[i] ? ' selected' : '') + '>' + allCategories[i] + '</option>';
}
html += '</select></div>';
html += '<div class="edit-field"><label>Corp/Personal</label><select id="editCorpPersonal"><option value="Corp"' + (lastSavedData.corpPersonal === 'Corp' ? ' selected' : '') + '>Corp</option><option value="Personal"' + (lastSavedData.corpPersonal === 'Personal' ? ' selected' : '') + '>Personal</option></select></div>';
html += '<div class="edit-field"><label>Description</label><input type="text" id="editExpenseDescription" value="' + (lastSavedData.description || '') + '"></div>';
}
else if (lastSavedData.type === 'allergy') {
title = 'Edit Allergy';
html = '<div class="edit-field"><label>Date</label><input type="date" id="editDate" value="' + lastSavedData.date + '"></div>';
html += '<div class="edit-field"><label>Right</label><input type="number" step="0.05" id="editRight" value="' + lastSavedData.right + '"></div>';
html += '<div class="edit-field"><label>Left</label><input type="number" step="0.05" id="editLeft" value="' + lastSavedData.left + '"></div>';
html += '<div class="edit-field"><label>Notes</label><input type="text" id="editNotes" value="' + (lastSavedData.notes || '') + '"></div>';
}

document.getElementById('editTitle').textContent = title;
document.getElementById('editFields').innerHTML = html;
document.getElementById('editPrompt').classList.add('active');
}

function saveCorrection() {
var correctedData = { type: lastSavedData.type };

if (lastSavedData.type === 'mileage') {
correctedData.date = document.getElementById('editDate').value;
correctedData.finish = parseInt(document.getElementById('editOdometer').value);
correctedData.from = document.getElementById('editFrom').value;
correctedData.to = document.getElementById('editTo').value;
correctedData.wp = document.getElementById('editWP').value;
correctedData.description = document.getElementById('editDescription').value;
}
else if (lastSavedData.type === 'gas') {
correctedData.date = document.getElementById('editDate').value;
correctedData.odometer = parseInt(document.getElementById('editOdometer').value);
correctedData.liters = parseFloat(document.getElementById('editLiters').value);
correctedData.price = parseFloat(document.getElementById('editPrice').value);
}
else if (lastSavedData.type === 'expense') {
correctedData.date = document.getElementById('editDate').value;
correctedData.amount = parseFloat(document.getElementById('editAmount').value);
correctedData.vendor = document.getElementById('editVendor').value;
correctedData.category = document.getElementById('editCategory').value;
correctedData.corpPersonal = document.getElementById('editCorpPersonal').value;
correctedData.paidOn = (correctedData.corpPersonal === 'Corp') ? 'Corp Card' : 'Personal Card';
correctedData.description = document.getElementById('editExpenseDescription').value;
}
else if (lastSavedData.type === 'allergy') {
correctedData.date = document.getElementById('editDate').value;
correctedData.right = parseFloat(document.getElementById('editRight').value);
correctedData.left = parseFloat(document.getElementById('editLeft').value);
correctedData.notes = document.getElementById('editNotes').value;
}

// Add delete info for old row
if (lastSavedRow && lastSavedSheet) {
correctedData.deleteRow = lastSavedRow;
correctedData.deleteSheet = lastSavedSheet;
}

document.getElementById('editPrompt').classList.remove('active');
submitData(correctedData, true);
}

function cancelCorrection() {
document.getElementById('editPrompt').classList.remove('active');
}

function submitData(data, isCorrection) {
var scriptUrl = localStorage.getItem('scriptUrl');
if (!scriptUrl) {
updateStatus('Please set Script URL', true);
document.getElementById('configSection').classList.remove('hidden');
return;
}

updateStatus('Saving...');
hideCorrectButton();

var params = [];
for (var key in data) {
if (data[key] !== null && data[key] !== undefined) {
params.push(encodeURIComponent(key) + '=' + encodeURIComponent(data[key]));
}
}

var url = scriptUrl + '?' + params.join('&');

// Store for potential correction (without delete info)
var dataToStore = JSON.parse(JSON.stringify(data));
delete dataToStore.deleteRow;
delete dataToStore.deleteSheet;
lastSavedData = dataToStore;

var img = new Image();
img.onload = function() {
showSuccess(data, isCorrection);
};
img.onerror = function() {
showSuccess(data, isCorrection);
};
img.src = url;
}

function showSuccess(data, isCorrection) {
var summary = '';
if (data.type === 'mileage') summary = 'Mileage: ' + data.finish + ' km, ' + data.from + ' to ' + data.to + ', ' + data.wp;
else if (data.type === 'gas') summary = 'Gas: $' + data.price + ', ' + data.liters + 'L';
else if (data.type === 'expense') summary = 'Expense: $' + data.amount + ' ' + data.category;
else if (data.type === 'allergy') summary = 'Allergy: R=' + data.right + ', L=' + data.left;

if (isCorrection) {
updateStatus('‚úÖ Corrected: ' + summary);
} else {
updateStatus('‚úÖ ' + summary);
}

// Track row info for corrections
var sheetMap = {
'mileage': 'Mileage',
'gas': 'Gas',
'expense': 'Expenses',
'allergy': 'Allergy Shots'
};
lastSavedSheet = sheetMap[data.type];

// We estimate the row - it will be the first empty row
// This is a limitation since we can't get the actual row back from the image request
// For now, we'll track it client-side
if (!data.deleteRow) {
lastSavedRow = 2; // Default estimate - user should correct immediately if needed
}

showCorrectButton();
}
</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Expense Tracker</title>
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
<style type="text/css">
body { font-family: -apple-system, sans-serif; background: #1a1a2e; margin: 0; padding: 20px; min-height: 100vh; box-sizing: border-box; }
h1 { color: white; text-align: center; font-size: 22px; margin-bottom: 20px; }
.auth-section { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
.auth-section.compact { padding: 8px 15px; margin-bottom: 10px; }
.signed-in-compact { display: flex; align-items: center; justify-content: center; gap: 10px; }
.signed-in-compact .user-info { margin: 0; font-size: 12px; }
.signed-in-compact .queue-info { margin: 0; font-size: 11px; }
.signed-in-compact .btn-signout { padding: 5px 10px; font-size: 11px; }
.auth-section p { color: white; font-size: 14px; margin-bottom: 15px; }
.btn-signin { padding: 12px 25px; background: #0078d4; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; }
.btn-signout { padding: 8px 15px; background: #666; color: white; border: none; border-radius: 5px; font-size: 12px; cursor: pointer; }
.user-info { color: #43e97b; font-size: 14px; margin-bottom: 10px; }
.queue-info { color: #ffa502; font-size: 12px; margin-top: 10px; }
.buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
.btn { padding: 20px 15px; font-size: 16px; font-weight: bold; border: none; border-radius: 15px; color: white; text-align: center; }
.btn-mileage { background: #667eea; }
.btn-gas { background: #f5576c; }
.btn-expense { background: #4facfe; }
.btn-allergy { background: #43e97b; }
.btn.active-recording { box-shadow: 0 0 20px rgba(255,255,255,0.8); }
.btn span { display: block; }
.btn .icon { font-size: 48px; margin-bottom: 5px; }
.btn .label { font-size: 14px; }
.btn-stop { background: #ff4757; padding: 20px; font-size: 18px; margin-top: 20px; width: 100%; border: none; border-radius: 15px; color: white; font-weight: bold; }
.btn-correct { background: #ffa502; padding: 12px 20px; font-size: 14px; margin-top: 10px; border: none; border-radius: 10px; color: white; font-weight: bold; }
.btn-delete { background: #ff4757; padding: 12px 20px; font-size: 14px; margin-top: 10px; margin-left: 10px; border: none; border-radius: 10px; color: white; font-weight: bold; }
.btn-retry { background: #ff6b81; padding: 12px 20px; font-size: 14px; margin-top: 10px; margin-left: 10px; border: none; border-radius: 10px; color: white; font-weight: bold; }
.btn-sync { background: #0078d4; padding: 12px 20px; font-size: 14px; margin-top: 10px; margin-left: 10px; border: none; border-radius: 10px; color: white; font-weight: bold; }
.recording-label { color: #ff4757; text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 10px; }
.status { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; color: white; min-height: 120px; }
.status-label { font-size: 11px; opacity: 0.7; margin-bottom: 8px; }
.prompt-text { font-size: 12px; white-space: pre-line; line-height: 1.3; color: #aaa; margin-bottom: 10px; }
.status-text { font-size: 14px; white-space: pre-line; line-height: 1.4; }
.transcript-box { background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; margin-top: 10px; min-height: 40px; }
.transcript-text { font-size: 14px; color: #43e97b; }
.offline-banner { background: #ff4757; color: white; text-align: center; padding: 10px; border-radius: 10px; margin-bottom: 15px; display: none; }
.offline-banner.show { display: block; }
.hidden { display: none; }
.disabled { opacity: 0.4; pointer-events: none; }
.overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); justify-content: center; align-items: center; z-index: 100; }
.overlay.active { display: flex; }
.popup { background: #1a1a2e; padding: 25px; border-radius: 15px; text-align: center; margin: 20px; max-width: 350px; width: 90%; max-height: 80vh; overflow-y: auto; }
.popup h2 { color: white; margin: 0 0 20px 0; font-size: 18px; }
.popup p { color: #aaa; font-size: 14px; margin-bottom: 20px; }
.popup button { padding: 15px 30px; margin: 5px; font-size: 16px; font-weight: bold; border: none; border-radius: 10px; color: white; min-width: 100px; }
.popup .btn1 { background: #4facfe; }
.popup .btn2 { background: #f5576c; }
.popup .btn-save { background: #43e97b; width: 100%; margin-top: 15px; }
.popup .btn-cancel { background: #666; width: 100%; margin-top: 10px; }
.popup .btn-confirm-delete { background: #ff4757; }
.edit-field { margin-bottom: 15px; text-align: left; }
.edit-field label { color: #aaa; font-size: 12px; display: block; margin-bottom: 5px; }
.edit-field input, .edit-field select { width: 100%; padding: 10px; border: none; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
.success { color: #43e97b; }
.error { color: #f5576c; }
.warning { color: #ffa502; }
.action-buttons { margin-top: 10px; }
.debug-panel { background: #000; border: 1px solid #333; border-radius: 8px; padding: 10px; margin-top: 20px; font-family: monospace; font-size: 11px; color: #0f0; max-height: 150px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }
.debug-panel .debug-error { color: #f55; }
.debug-panel .debug-success { color: #5f5; }
</style>
</head>
<body>

<div class="offline-banner" id="offlineBanner">üìµ Offline - entries will sync when connected</div>

<div style="position: relative;">
<h1>üìä Expense Tracker</h1>
<button id="signOutBtn" class="hidden" style="position: absolute; top: 0; right: 0; background: none; border: none; color: #666; font-size: 11px; padding: 5px;" onclick="signOut()">Sign out</button>
</div>

<div class="auth-section" id="authSection">
<div id="notSignedIn">
<p>Sign in with your Microsoft account to sync with your Excel file</p>
<button class="btn-signin" onclick="signIn()">Sign in with Microsoft</button>
</div>
<div id="signedIn" class="hidden signed-in-compact">
<span class="user-info" id="userInfo"></span>
<span class="queue-info hidden" id="queueInfo"></span>
<button class="btn-signout" onclick="signOut()">Sign out</button>
</div>
</div>

<div class="buttons" id="mainButtons">
<button class="btn btn-mileage" id="btnMileage" onclick="startEntry('mileage')">
<span class="icon">üöó</span>
<span class="label">Mileage</span>
</button>
<button class="btn btn-gas" id="btnGas" onclick="startEntry('gas')">
<span class="icon">‚õΩ</span>
<span class="label">Gas</span>
</button>
<button class="btn btn-expense" id="btnExpense" onclick="startEntry('expense')">
<span class="icon">üí≥</span>
<span class="label">Expense</span>
</button>
<button class="btn btn-allergy" id="btnAllergy" onclick="startEntry('allergy')">
<span class="icon">üíâ</span>
<span class="label">Allergy</span>
</button>
</div>

<div class="recording-label hidden" id="recordingLabel">üî¥ Recording: MILEAGE</div>

<div class="status">
<div class="status-label">Status</div>
<div class="prompt-text hidden" id="promptText"></div>
<div class="status-text" id="statusText">Sign in to start tracking expenses</div>
<div class="transcript-box hidden" id="transcriptBox">
<div class="transcript-text" id="transcriptText"></div>
</div>
</div>

<button class="btn btn-stop hidden" id="stopButton" onclick="stopListening()">
üõë Tap When Done Speaking
</button>

<div class="action-buttons">
<button class="btn btn-correct hidden" id="correctButton" onclick="showCorrectForm()">
‚úèÔ∏è Correct
</button>
<button class="btn btn-delete hidden" id="deleteButton" onclick="confirmDelete()">
üóëÔ∏è Delete
</button>
<button class="btn btn-retry hidden" id="retryButton" onclick="retryLastSubmit()">
üîÑ Retry
</button>
<button class="btn btn-sync hidden" id="syncButton" onclick="syncOfflineQueue()">
üì§ Sync Now
</button>
</div>

<div class="debug-panel" id="debugPanel">Debug log:</div>

<div class="overlay" id="wpPrompt">
<div class="popup">
<h2>Work or Personal?</h2>
<button class="btn1" onclick="selectWP('Work')">Work</button>
<button class="btn2" onclick="selectWP('Personal')">Personal</button>
</div>
</div>

<div class="overlay" id="corpPrompt">
<div class="popup">
<h2>Corp or Personal?</h2>
<button class="btn1" onclick="selectCorp('Corp')">Corp</button>
<button class="btn2" onclick="selectCorp('Personal')">Personal</button>
</div>
</div>

<div class="overlay" id="deletePrompt">
<div class="popup">
<h2>üóëÔ∏è Delete Entry?</h2>
<p id="deleteDescription">Are you sure you want to delete this entry?</p>
<button class="btn-confirm-delete" onclick="executeDelete()">Yes, Delete</button>
<button class="btn-cancel" onclick="cancelDelete()">Cancel</button>
</div>
</div>

<div class="overlay" id="editPrompt">
<div class="popup">
<h2 id="editTitle">Edit Entry</h2>
<div id="editFields"></div>
<button class="btn-save" onclick="saveCorrection()">Save Changes</button>
<button class="btn-cancel" onclick="cancelCorrection()">Cancel</button>
</div>
</div>

<script>
// Microsoft Authentication Configuration
var msalConfig = {
  auth: {
    clientId: '631c42f5-7d47-4e12-b22d-addf5cf595c9',
    authority: 'https://login.microsoftonline.com/consumers',
    redirectUri: window.location.origin + window.location.pathname
  },
  cache: {
    cacheLocation: 'localStorage',
    storeAuthStateInCookie: false
  }
};

var msalInstance = new msal.PublicClientApplication(msalConfig);
var accessToken = null;

// Excel file path in OneDrive
var excelFilePath = '/03. ACCOUNTING/2026/2026 EXPENSES.xlsx';

// Voice recognition variables
var recognition;
var currentType = null;
var pendingData = {};
var lastSavedData = {};
var lastSavedRow = null;
var lastSavedSheet = null;
var lastSubmitData = null;
var spokenText = '';
var submitAttempts = 0;
var maxRetries = 3;
var requestTimeout = 30000;
var micRetryCount = 0;
var maxMicRetries = 3;
var isRecognitionActive = false;

// Debug logging for mobile
function debugLog(msg, isError) {
  var panel = document.getElementById('debugPanel');
  var time = new Date().toLocaleTimeString();
  var cls = isError ? 'debug-error' : '';
  panel.innerHTML += '\n<span class="' + cls + '">[' + time + '] ' + msg + '</span>';
  panel.scrollTop = panel.scrollHeight;
  console.log(msg);
}
var intentionalStop = false;

// Offline queue
var offlineQueue = JSON.parse(localStorage.getItem('expenseQueue') || '[]');

var prompts = {
  mileage: 'Date (if empty = today)\nFinish\nFrom\nTo\nWork or Personal\nFor (description)',
  gas: 'Date (if empty = today)\nOdometer\nLitres\nPrice',
  expense: 'Date (if empty = today)\nAmount, Vendor, for Description, Category, Corp/Personal\n\nPersonal: FYI, Non-BUH, Donations, Special, Health\nAuto: Parking, Repairs, Wash\nCorp: Office, CME, License/Membership, BUH, Travel, Hotels, Meals, Gifts',
  allergy: 'Date (if empty = today)\nRight, Left or Both amount\nNotes'
};

var categoryKeywords = {
  'parking': 'Parking',
  'repair': 'Repairs & Maintenance',
  'repairs': 'Repairs & Maintenance',
  'maintenance': 'Repairs & Maintenance',
  'car wash': 'Auto Wash',
  'auto wash': 'Auto Wash',
  'wash': 'Auto Wash',
  'meals': 'Meals & Entertainment',
  'meal': 'Meals & Entertainment',
  'dinner': 'Meals & Entertainment',
  'lunch': 'Meals & Entertainment',
  'breakfast': 'Meals & Entertainment',
  'entertainment': 'Meals & Entertainment',
  'promotion': 'Promotions/Gifts/Tickets',
  'gift': 'Promotions/Gifts/Tickets',
  'ticket': 'Promotions/Gifts/Tickets',
  'tickets': 'Promotions/Gifts/Tickets',
  'office': 'Office/Postage/Stationery',
  'postage': 'Office/Postage/Stationery',
  'stationery': 'Office/Postage/Stationery',
  'hotel': 'Hotels',
  'hotels': 'Hotels',
  'travel': 'Travel Fares',
  'flight': 'Travel Fares',
  'airfare': 'Travel Fares',
  'fare': 'Travel Fares',
  'phone': 'Phone/Internet',
  'internet': 'Phone/Internet',
  'other business': 'Other Business',
  'buh': 'BUH',
  'cme': 'CME',
  'course': 'CME',
  'book': 'CME',
  'subscription': 'CME',
  'education': 'CME',
  'membership': 'License/Membership Fees',
  'dues': 'License/Membership Fees',
  'license': 'License/Membership Fees',
  'non-buh': 'NON-BUH',
  'non buh': 'NON-BUH',
  'donation': 'Donations',
  'donations': 'Donations',
  'charitable': 'Donations',
  'special': 'Special Expenses',
  'fyi': 'FYI',
  'health': 'Health'
};

var allCategories = ['Parking', 'Repairs & Maintenance', 'Auto Wash', 'Meals & Entertainment', 'Promotions/Gifts/Tickets', 'Office/Postage/Stationery', 'Hotels', 'Travel Fares', 'Phone/Internet', 'Other Business', 'BUH', 'CME', 'License/Membership Fees', 'NON-BUH', 'Donations', 'Special Expenses', 'FYI', 'Health'];

// Microsoft Authentication Functions
async function signIn() {
  try {
    var loginRequest = {
      scopes: ['Files.ReadWrite', 'User.Read']
    };
    var response = await msalInstance.loginPopup(loginRequest);
    await getToken();
    updateAuthUI();
    updateStatus('Ready. Tap a button to start.');
  } catch (error) {
    console.error('Login error:', error);
    updateStatus('Sign in failed: ' + error.message, true);
  }
}

function signOut() {
  msalInstance.logoutPopup();
  accessToken = null;
  updateAuthUI();
  updateStatus('Signed out. Sign in to track expenses.');
}

async function getToken() {
  var accounts = msalInstance.getAllAccounts();
  if (accounts.length === 0) {
    return null;
  }

  var tokenRequest = {
    scopes: ['Files.ReadWrite', 'User.Read'],
    account: accounts[0]
  };

  try {
    var response = await msalInstance.acquireTokenSilent(tokenRequest);
    accessToken = response.accessToken;
    return accessToken;
  } catch (error) {
    if (error.name === 'InteractionRequiredAuthError') {
      var response = await msalInstance.acquireTokenPopup(tokenRequest);
      accessToken = response.accessToken;
      return accessToken;
    }
    throw error;
  }
}

function updateAuthUI() {
  var accounts = msalInstance.getAllAccounts();
  if (accounts.length > 0) {
    document.getElementById('authSection').classList.add('hidden');
    document.getElementById('signOutBtn').classList.remove('hidden');
    document.getElementById('mainButtons').classList.remove('disabled');
    updateQueueInfo();
  } else {
    document.getElementById('authSection').classList.remove('hidden');
    document.getElementById('signOutBtn').classList.add('hidden');
    document.getElementById('notSignedIn').classList.remove('hidden');
    document.getElementById('signedIn').classList.add('hidden');
    document.getElementById('mainButtons').classList.add('disabled');
  }
}

function updateQueueInfo() {
  var queueInfo = document.getElementById('queueInfo');
  var syncBtn = document.getElementById('syncButton');
  if (offlineQueue.length > 0) {
    queueInfo.textContent = 'üìã ' + offlineQueue.length + ' entries waiting to sync';
    queueInfo.classList.remove('hidden');
    syncBtn.classList.remove('hidden');
  } else {
    queueInfo.classList.add('hidden');
    syncBtn.classList.add('hidden');
  }
}

// Online/Offline handling
function updateOnlineStatus() {
  var banner = document.getElementById('offlineBanner');
  if (navigator.onLine) {
    banner.classList.remove('show');
    if (offlineQueue.length > 0 && accessToken) {
      syncOfflineQueue();
    }
  } else {
    banner.classList.add('show');
  }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// Initialize speech recognition
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  recognition.onresult = function(event) {
    var text = '';
    for (var i = 0; i < event.results.length; i++) {
      text += event.results[i][0].transcript;
    }
    spokenText = text;
    document.getElementById('transcriptText').textContent = 'üé§ ' + text;
  };

  recognition.onstart = function() {
    isRecognitionActive = true;
    updateStatus('Listening... (attempt ' + (micRetryCount + 1) + ' of ' + (maxMicRetries + 1) + ')');
  };

  recognition.onerror = function(event) {
    isRecognitionActive = false;
    if ((event.error === 'aborted' || event.error === 'no-speech') && micRetryCount < maxMicRetries) {
      micRetryCount++;
      setTimeout(function() {
        if (!intentionalStop && recognition) {
          try {
            recognition.start();
          } catch(e) {
            updateStatus('Mic error. Tap button to try again.', true);
            showMainButtons();
          }
        }
      }, 1000);
      return;
    }
    updateStatus('Mic error: ' + event.error + '. Tap button to try again.', true);
    showMainButtons();
  };

  recognition.onend = function() {
    isRecognitionActive = false;
  };
}

// Initialize on page load
window.onload = async function() {
  updateOnlineStatus();

  // Check if already signed in
  var accounts = msalInstance.getAllAccounts();
  if (accounts.length > 0) {
    try {
      await getToken();
      updateAuthUI();
      updateStatus('Ready. Tap a button to start.');
    } catch (e) {
      updateAuthUI();
      updateStatus('Sign in to start tracking expenses.');
    }
  } else {
    updateAuthUI();
    updateStatus('Sign in to start tracking expenses.');
  }

  updateQueueInfo();
};

function updateStatus(text, isError, statusType) {
  var el = document.getElementById('statusText');
  el.textContent = text;
  if (isError) {
    el.className = 'status-text error';
  } else if (statusType === 'success') {
    el.className = 'status-text success';
  } else if (statusType === 'warning') {
    el.className = 'status-text warning';
  } else {
    el.className = 'status-text';
  }
}

function showPrompt(type) {
  var promptEl = document.getElementById('promptText');
  var transcriptBox = document.getElementById('transcriptBox');
  promptEl.textContent = prompts[type];
  promptEl.classList.remove('hidden');
  transcriptBox.classList.remove('hidden');
  document.getElementById('transcriptText').textContent = 'üé§ Listening...';
}

function hidePrompt() {
  document.getElementById('promptText').classList.add('hidden');
  document.getElementById('transcriptBox').classList.add('hidden');
}

function showMainButtons() {
  document.getElementById('mainButtons').classList.remove('disabled');
  document.getElementById('stopButton').classList.add('hidden');
  document.getElementById('recordingLabel').classList.add('hidden');
  clearActiveButton();
  hidePrompt();
}

function hideMainButtons() {
  document.getElementById('mainButtons').classList.add('disabled');
  document.getElementById('stopButton').classList.remove('hidden');
}

function showCorrectButton() {
  document.getElementById('correctButton').classList.remove('hidden');
}

function hideCorrectButton() {
  document.getElementById('correctButton').classList.add('hidden');
}

function showDeleteButton() {
  document.getElementById('deleteButton').classList.remove('hidden');
}

function hideDeleteButton() {
  document.getElementById('deleteButton').classList.add('hidden');
}

function showRetryButton() {
  document.getElementById('retryButton').classList.remove('hidden');
}

function hideRetryButton() {
  document.getElementById('retryButton').classList.add('hidden');
}

function setActiveButton(type) {
  clearActiveButton();
  var btnId = 'btn' + type.charAt(0).toUpperCase() + type.slice(1);
  var btn = document.getElementById(btnId);
  if (btn) {
    btn.classList.add('active-recording');
  }
}

function clearActiveButton() {
  var buttons = ['btnMileage', 'btnGas', 'btnExpense', 'btnAllergy'];
  buttons.forEach(function(id) {
    var btn = document.getElementById(id);
    if (btn) {
      btn.classList.remove('active-recording');
    }
  });
}

function startEntry(type) {
  var accounts = msalInstance.getAllAccounts();
  if (accounts.length === 0) {
    updateStatus('Please sign in first.', true);
    return;
  }

  currentType = type;
  pendingData = {};
  spokenText = '';
  hideCorrectButton();
  hideDeleteButton();
  hideRetryButton();
  lastSavedRow = null;
  lastSavedSheet = null;
  submitAttempts = 0;
  micRetryCount = 0;

  var recordLabels = {
    mileage: 'üî¥ MILEAGE',
    gas: 'üî¥ GAS',
    expense: 'üî¥ EXPENSE',
    allergy: 'üî¥ ALLERGY'
  };

  updateStatus('Speak now...');
  showPrompt(type);
  document.getElementById('recordingLabel').textContent = recordLabels[type];
  document.getElementById('recordingLabel').classList.remove('hidden');
  hideMainButtons();
  setActiveButton(type);

  if (recognition) {
    if (isRecognitionActive) {
      try { recognition.stop(); } catch(e) {}
    }
    intentionalStop = false;
    setTimeout(function() {
      try {
        recognition.start();
      } catch(e) {
        updateStatus('Mic error. Tap button to try again.', true);
        showMainButtons();
      }
    }, 250);
  } else {
    updateStatus('Speech not supported.', true);
    showMainButtons();
  }
}

function stopListening() {
  intentionalStop = true;
  if (recognition) {
    try { recognition.stop(); } catch(e) {}
  }
  isRecognitionActive = false;
  showMainButtons();

  var transcript = spokenText.trim().toLowerCase();
  if (!transcript) {
    updateStatus('No speech detected. Tap a button to try again.', true);
    return;
  }

  updateStatus('Processing...');
  processVoiceInput(transcript);
}

function processVoiceInput(transcript) {
  if (currentType === 'mileage') parseMileage(transcript);
  else if (currentType === 'gas') parseGas(transcript);
  else if (currentType === 'expense') parseExpense(transcript);
  else if (currentType === 'allergy') parseAllergy(transcript);
}

function formatDate(d) {
  var yyyy = d.getFullYear();
  var mm = String(d.getMonth() + 1).padStart(2, '0');
  var dd = String(d.getDate()).padStart(2, '0');
  return yyyy + '-' + mm + '-' + dd;
}

function parseDate(text) {
  var today = new Date();
  var d = null;

  if (text.indexOf('yesterday') !== -1) {
    d = new Date();
    d.setDate(d.getDate() - 1);
    return formatDate(d);
  }

  var lastDayMatch = text.match(/last\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i);
  if (lastDayMatch) {
    var days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    var targetDay = days.indexOf(lastDayMatch[1].toLowerCase());
    d = new Date();
    var currentDay = d.getDay();
    var diff = currentDay - targetDay;
    if (diff <= 0) diff += 7;
    d.setDate(d.getDate() - diff);
    return formatDate(d);
  }

  var months = {
    'january': 0, 'jan': 0, 'february': 1, 'feb': 1, 'march': 2, 'mar': 2,
    'april': 3, 'apr': 3, 'may': 4, 'june': 5, 'jun': 5, 'july': 6, 'jul': 6,
    'august': 7, 'aug': 7, 'september': 8, 'sep': 8, 'sept': 8,
    'october': 9, 'oct': 9, 'november': 10, 'nov': 10, 'december': 11, 'dec': 11
  };

  var monthDayMatch = text.match(/(january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|jun|jul|aug|sep|sept|oct|nov|dec)\s+(\d{1,2})(?:st|nd|rd|th)?/i);
  if (monthDayMatch) {
    var month = months[monthDayMatch[1].toLowerCase()];
    var day = parseInt(monthDayMatch[2]);
    var year = today.getFullYear();
    d = new Date(year, month, day);
    if (d > today) {
      d.setFullYear(year - 1);
    }
    return formatDate(d);
  }

  return formatDate(today);
}

function parseSpokenNumber(text) {
  var ones = {'zero':0,'oh':0,'o':0,'one':1,'two':2,'to':2,'too':2,'three':3,'four':4,'for':4,'five':5,'six':6,'seven':7,'eight':8,'nine':9,'ten':10,'eleven':11,'twelve':12,'thirteen':13,'fourteen':14,'fifteen':15,'sixteen':16,'seventeen':17,'eighteen':18,'nineteen':19};
  var tens = {'twenty':20,'thirty':30,'forty':40,'fifty':50,'sixty':60,'seventy':70,'eighty':80,'ninety':90};

  var allDigits = text.match(/\d+/g);
  if (allDigits) {
    for (var i = 0; i < allDigits.length; i++) {
      if (allDigits[i].length >= 5) {
        return parseInt(allDigits[i]);
      }
    }
    var combined = allDigits.join('');
    if (combined.length >= 5) {
      return parseInt(combined);
    }
  }

  var total = 0;
  var current = 0;
  var words = text.toLowerCase().split(/[\s,-]+/);

  for (var i = 0; i < words.length; i++) {
    var w = words[i];
    if (ones[w] !== undefined) {
      current += ones[w];
    } else if (tens[w] !== undefined) {
      current += tens[w];
    } else if (w === 'hundred') {
      current *= 100;
    } else if (w === 'thousand') {
      current *= 1000;
      total += current;
      current = 0;
    } else if (w === 'million') {
      current *= 1000000;
      total += current;
      current = 0;
    }
  }
  total += current;

  if (total >= 10000) return total;

  var digitWords = text.match(/\b(zero|oh|o|one|two|to|too|three|four|for|five|six|seven|eight|nine)\b/gi);
  if (digitWords && digitWords.length >= 5) {
    var numStr = '';
    for (var i = 0; i < digitWords.length; i++) {
      var dw = digitWords[i].toLowerCase();
      if (ones[dw] !== undefined) {
        numStr += ones[dw];
      }
    }
    if (numStr.length >= 5) {
      return parseInt(numStr);
    }
  }

  return null;
}

function parseMileage(text) {
  var finish = parseSpokenNumber(text);
  var cleanText = text.replace(/\b(the|a|an)\b/g, '').replace(/\s+/g, ' ');
  var toMatch = cleanText.match(/(?:from\s+)?(\w+)\s+to\s+(\w+)/i);
  var from = toMatch ? toMatch[1] : '';
  var to = toMatch ? toMatch[2] : '';

  var wp = null;
  if (text.indexOf('work') !== -1 || text.indexOf('corp') !== -1 || text.indexOf('corporate') !== -1) wp = 'Work';
  else if (text.indexOf('personal') !== -1) wp = 'Personal';

  var date = parseDate(text);

  var description = '';
  var forMatch = text.match(/\bfor\s+(.+)$/i);
  if (forMatch) {
    description = forMatch[1]
      .replace(/\bwork\b/gi, '')
      .replace(/\bpersonal\b/gi, '')
      .replace(/\bcorp\b/gi, '')
      .replace(/\bcorporate\b/gi, '')
      .replace(/\b\d{5,}\b/g, '')
      .replace(/\s+/g, ' ')
      .trim();
  }

  pendingData = { type: 'mileage', finish: finish, from: from, to: to, wp: wp, date: date, description: description };

  if (!finish) {
    updateStatus('Could not find odometer. Tap üöó to try again.', true);
    return;
  }
  if (!wp) {
    document.getElementById('wpPrompt').classList.add('active');
  } else {
    submitData(pendingData, false);
  }
}

function parseGas(text) {
  var price = null;
  var priceMatch = text.match(/\$\s*(\d+(?:\.\d+)?)/i);
  if (priceMatch) {
    price = parseFloat(priceMatch[1]);
  } else {
    priceMatch = text.match(/(\d+(?:\.\d+)?)\s*dollars?/i);
    if (priceMatch) {
      price = parseFloat(priceMatch[1]);
    }
  }

  var litersMatch = text.match(/(\d+(?:\.\d+)?)\s*(?:liters?|litres?|l)\b/i);
  var liters = litersMatch ? parseFloat(litersMatch[1]) : null;

  var odometerMatch = text.match(/(\d{1,7})\s*(?:km|kilometers?|kilometres?)\b/i);
  if (!odometerMatch) {
    odometerMatch = text.match(/\b(\d{5,7})\b/);
  }
  var odometer = odometerMatch ? parseInt(odometerMatch[1]) : null;

  var date = parseDate(text);

  pendingData = { type: 'gas', price: price, liters: liters, odometer: odometer, date: date };

  if (!price || !liters || !odometer) {
    var missing = [];
    if (!price) missing.push('Price');
    if (!liters) missing.push('Liters');
    if (!odometer) missing.push('Odometer');
    updateStatus('‚ùå Need ' + missing.join(', ') + '. Tap ‚õΩ to try again.', true);
    return;
  }
  submitData(pendingData, false);
}

function parseExpense(text) {
  var amount = null;
  var amountEndPos = 0;
  var amountMatch = text.match(/\$\s*(\d+(?:\.\d+)?)/i);
  if (amountMatch) {
    amount = parseFloat(amountMatch[1]);
    amountEndPos = text.indexOf(amountMatch[0]) + amountMatch[0].length;
  } else {
    amountMatch = text.match(/(\d+(?:\.\d+)?)\s*dollars?/i);
    if (amountMatch) {
      amount = parseFloat(amountMatch[1]);
      amountEndPos = text.indexOf(amountMatch[0]) + amountMatch[0].length;
    }
  }

  var category = null;
  var matchedKeyword = '';
  var categoryPos = -1;
  for (var keyword in categoryKeywords) {
    var pos = text.toLowerCase().indexOf(keyword);
    if (pos !== -1) {
      category = categoryKeywords[keyword];
      matchedKeyword = keyword;
      categoryPos = pos;
      break;
    }
  }

  var autoPersonal = ['NON-BUH', 'Donations', 'Special Expenses', 'FYI', 'Health'];
  var autoCorp = ['CME', 'License/Membership Fees'];

  var corpPersonal = null;
  var paidOn = null;

  if (autoPersonal.indexOf(category) !== -1) {
    corpPersonal = 'Personal';
    paidOn = 'Personal Card';
  } else if (autoCorp.indexOf(category) !== -1) {
    corpPersonal = 'Corp';
    paidOn = 'Corp Card';
  } else if (text.indexOf('corp on personal') !== -1) {
    corpPersonal = 'Corp';
    paidOn = 'Personal Card';
  } else if (text.indexOf('corp') !== -1 || text.indexOf('corporate') !== -1) {
    corpPersonal = 'Corp';
    paidOn = 'Corp Card';
  } else if (text.indexOf('personal') !== -1) {
    corpPersonal = 'Personal';
    paidOn = 'Personal Card';
  }

  var vendor = '';
  var description = '';
  var textAfterAmount = text.substring(amountEndPos).trim();
  var forPos = textAfterAmount.toLowerCase().indexOf(' for ');

  if (forPos !== -1) {
    vendor = textAfterAmount.substring(0, forPos).trim();
    var afterFor = textAfterAmount.substring(forPos + 5).trim();
    if (matchedKeyword) {
      var catPosInAfterFor = afterFor.toLowerCase().indexOf(matchedKeyword);
      if (catPosInAfterFor !== -1) {
        description = afterFor.substring(0, catPosInAfterFor).trim();
      } else {
        description = afterFor;
      }
    } else {
      description = afterFor;
    }
    description = description.replace(/\b(corp|corporate|personal)\b/gi, '').trim();
  } else {
    if (categoryPos !== -1) {
      var vendorText = textAfterAmount.substring(0, textAfterAmount.toLowerCase().indexOf(matchedKeyword));
      vendor = vendorText.replace(/\b(corp|corporate|personal)\b/gi, '').trim();
    } else {
      vendor = textAfterAmount.replace(/\b(corp|corporate|personal)\b/gi, '').trim();
    }
  }

  var date = parseDate(text);

  pendingData = { type: 'expense', amount: amount, category: category, corpPersonal: corpPersonal, paidOn: paidOn, vendor: vendor, description: description, date: date };

  if (!amount) {
    updateStatus('Need amount (X dollars). Tap üí≥ to try again.', true);
    return;
  }
  if (!category) {
    updateStatus('Need category. Tap üí≥ to try again.', true);
    return;
  }
  if (!corpPersonal) {
    document.getElementById('corpPrompt').classList.add('active');
  } else {
    submitData(pendingData, false);
  }
}

function parseAllergy(text) {
  var right = null;
  var left = null;
  var notes = '';

  if (text.indexOf('both') !== -1) {
    var doseMatch = text.match(/(\d+(?:\.\d+)?)/);
    if (doseMatch) {
      right = parseFloat(doseMatch[1]);
      left = right;
    }
  } else {
    var rightMatch = text.match(/(\d+(?:\.\d+)?)\s*right/i) || text.match(/right\s*(\d+(?:\.\d+)?)/i);
    var leftMatch = text.match(/(\d+(?:\.\d+)?)\s*left/i) || text.match(/left\s*(\d+(?:\.\d+)?)/i);
    if (rightMatch) right = parseFloat(rightMatch[1]);
    if (leftMatch) left = parseFloat(leftMatch[1]);
  }

  var notesMatch = text.match(/(?:notes?|comment)\s+(.+)$/i);
  if (notesMatch) {
    notes = notesMatch[1].trim();
  }

  var date = parseDate(text);

  pendingData = { type: 'allergy', right: right, left: left, notes: notes, date: date };

  if (!right && !left) {
    updateStatus('Need dose. Say "0.3 both". Tap üíâ to try again.', true);
    return;
  }
  submitData(pendingData, false);
}

function selectWP(value) {
  document.getElementById('wpPrompt').classList.remove('active');
  pendingData.wp = value;
  submitData(pendingData, false);
}

function selectCorp(value) {
  document.getElementById('corpPrompt').classList.remove('active');
  pendingData.corpPersonal = value;
  pendingData.paidOn = (value === 'Corp') ? 'Corp Card' : 'Personal Card';
  submitData(pendingData, false);
}

// Microsoft Graph API - Add row to Excel
async function addRowToExcel(sheetName, rowData) {
  debugLog('Starting save to sheet: ' + sheetName);

  var token = await getToken();
  if (!token) {
    debugLog('ERROR: Not authenticated', true);
    throw new Error('Not authenticated');
  }
  debugLog('Got auth token');

  // Encode path: replace spaces with %20 but keep slashes
  var encodedPath = excelFilePath.split('/').map(function(segment) {
    return encodeURIComponent(segment);
  }).join('/');
  debugLog('File path: ' + encodedPath);

  // Get Column A (Date) to find first empty row - ignores formula-only rows
  var colAUrl = 'https://graph.microsoft.com/v1.0/me/drive/root:' + encodedPath + ':/workbook/worksheets/' + encodeURIComponent(sheetName) + '/range(address=\'A1:A500\')';

  debugLog('Fetching Column A to find first empty row...');
  var colAResponse = await fetch(colAUrl, {
    headers: { 'Authorization': 'Bearer ' + token }
  });

  debugLog('Column A response: HTTP ' + colAResponse.status);

  if (!colAResponse.ok) {
    var errorText = await colAResponse.text();
    debugLog('ERROR: ' + errorText, true);
    throw new Error('Sheet "' + sheetName + '" not found or file error (HTTP ' + colAResponse.status + ')');
  }

  var colAData = await colAResponse.json();
  var values = colAData.values || [];

  // Find first empty row in Column A (skip header row)
  var lastRow = 2; // Start at row 2 (after header)
  for (var i = 1; i < values.length; i++) {
    if (values[i] && values[i][0] && values[i][0].toString().trim() !== '') {
      lastRow = i + 2; // Next row after this data row (1-indexed + skip header)
    }
  }
  debugLog('First empty Date row: ' + lastRow);

  // Handle new format with multiple ranges (to skip formula columns)
  if (rowData.ranges) {
    for (var r = 0; r < rowData.ranges.length; r++) {
      var range = rowData.ranges[r];
      var startCol = range.col;
      var endCol = String.fromCharCode(startCol.charCodeAt(0) + range.values.length - 1);
      var rangeAddress = startCol + lastRow + ':' + endCol + lastRow;
      debugLog('Writing to range: ' + rangeAddress);

      var updateUrl = 'https://graph.microsoft.com/v1.0/me/drive/root:' + encodedPath + ':/workbook/worksheets/' + encodeURIComponent(sheetName) + '/range(address=\'' + rangeAddress + '\')';

      var updateResponse = await fetch(updateUrl, {
        method: 'PATCH',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          values: [range.values]
        })
      });

      debugLog('Write response: HTTP ' + updateResponse.status);

      if (!updateResponse.ok) {
        var errorData = await updateResponse.json();
        debugLog('ERROR: ' + JSON.stringify(errorData), true);
        throw new Error(errorData.error?.message || 'Failed to write row (HTTP ' + updateResponse.status + ')');
      }
    }
    debugLog('SUCCESS! Wrote to row ' + lastRow, false);
    return { success: true, row: lastRow };
  }

  // Original format: simple array for all columns
  var numColumns = rowData.length;
  var endColumn = String.fromCharCode(64 + numColumns);
  var rangeAddress = 'A' + lastRow + ':' + endColumn + lastRow;
  debugLog('Range: ' + rangeAddress);

  var updateUrl = 'https://graph.microsoft.com/v1.0/me/drive/root:' + encodedPath + ':/workbook/worksheets/' + encodeURIComponent(sheetName) + '/range(address=\'' + rangeAddress + '\')';

  debugLog('Writing data...');
  var updateResponse = await fetch(updateUrl, {
    method: 'PATCH',
    headers: {
      'Authorization': 'Bearer ' + token,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      values: [rowData]
    })
  });

  debugLog('Write response: HTTP ' + updateResponse.status);

  if (!updateResponse.ok) {
    var errorData = await updateResponse.json();
    debugLog('ERROR: ' + JSON.stringify(errorData), true);
    throw new Error(errorData.error?.message || 'Failed to write row (HTTP ' + updateResponse.status + ')');
  }

  var result = await updateResponse.json();
  debugLog('SUCCESS! Wrote to row ' + lastRow, false);
  return { success: true, row: lastRow };
}

async function submitData(data, isCorrection) {
  submitAttempts++;
  lastSubmitData = { data: data, isCorrection: isCorrection };

  // If offline, queue the entry
  if (!navigator.onLine) {
    queueOfflineEntry(data);
    var summary = getSummary(data);
    updateStatus('üìã Queued (offline): ' + summary, false, 'warning');
    hideRetryButton();
    updateQueueInfo();
    return;
  }

  hideCorrectButton();
  hideDeleteButton();
  hideRetryButton();

  var sheetName, rowData;

  if (data.type === 'mileage') {
    sheetName = 'Mileage';
    // Mileage has formulas in columns B and F - write to other columns only
    rowData = {
      ranges: [
        { col: 'A', values: [data.date] },
        { col: 'C', values: [data.finish, data.from || '', data.to || ''] },  // C, D, E
        { col: 'G', values: [data.wp, data.description || ''] }  // G, H
      ]
    };
  } else if (data.type === 'gas') {
    sheetName = 'Gas';
    rowData = [data.date, data.odometer, data.liters, data.price, ''];
  } else if (data.type === 'expense') {
    sheetName = 'Expenses';
    rowData = [data.date, data.amount, data.vendor || '', data.description || '', data.category, data.corpPersonal, data.paidOn];
  } else if (data.type === 'allergy') {
    sheetName = 'Allergy Shots';
    rowData = [data.date, data.right || '', data.left || '', data.notes || ''];
  }

  updateStatus('Saving to ' + sheetName + '... (' + submitAttempts + '/' + maxRetries + ')', false, 'warning');

  try {
    var result = await addRowToExcel(sheetName, rowData);

    lastSavedData = JSON.parse(JSON.stringify(data));
    lastSavedSheet = sheetName;
    lastSavedRow = result.row;

    showSuccess(data, isCorrection);

  } catch (error) {
    console.error('Submit error:', error);

    if (submitAttempts < maxRetries) {
      setTimeout(function() {
        submitData(data, isCorrection);
      }, 2000);
    } else {
      // Queue for later if all retries failed
      queueOfflineEntry(data);
      updateStatus('‚ö†Ô∏è Queued for later: ' + error.message, false, 'warning');
      showRetryButton();
      updateQueueInfo();
    }
  }
}

function queueOfflineEntry(data) {
  data.queuedAt = new Date().toISOString();
  offlineQueue.push(data);
  localStorage.setItem('expenseQueue', JSON.stringify(offlineQueue));
}

async function syncOfflineQueue() {
  if (offlineQueue.length === 0) {
    updateStatus('No entries to sync.', false);
    return;
  }

  if (!navigator.onLine) {
    updateStatus('Cannot sync - no internet connection.', true);
    return;
  }

  updateStatus('Syncing ' + offlineQueue.length + ' entries...', false, 'warning');

  var succeeded = 0;
  var failed = 0;
  var remaining = [];

  for (var i = 0; i < offlineQueue.length; i++) {
    var entry = offlineQueue[i];
    try {
      var sheetName, rowData;

      if (entry.type === 'mileage') {
        sheetName = 'Mileage';
        rowData = [entry.date, '', entry.finish, entry.from || '', entry.to || '', '', entry.wp, entry.description || ''];
      } else if (entry.type === 'gas') {
        sheetName = 'Gas';
        rowData = [entry.date, entry.odometer, entry.liters, entry.price, ''];
      } else if (entry.type === 'expense') {
        sheetName = 'Expenses';
        rowData = [entry.date, entry.amount, entry.vendor || '', entry.description || '', entry.category, entry.corpPersonal, entry.paidOn];
      } else if (entry.type === 'allergy') {
        sheetName = 'Allergy Shots';
        rowData = [entry.date, entry.right || '', entry.left || '', entry.notes || ''];
      }

      await addRowToExcel(sheetName, rowData);
      succeeded++;
      updateStatus('Syncing... ' + succeeded + ' done', false, 'warning');

    } catch (error) {
      console.error('Sync error for entry:', error);
      remaining.push(entry);
      failed++;
    }
  }

  offlineQueue = remaining;
  localStorage.setItem('expenseQueue', JSON.stringify(offlineQueue));
  updateQueueInfo();

  if (failed === 0) {
    updateStatus('‚úÖ Synced ' + succeeded + ' entries!', false, 'success');
  } else {
    updateStatus('‚ö†Ô∏è Synced ' + succeeded + ', failed ' + failed, false, 'warning');
  }
}

function getSummary(data) {
  if (data.type === 'mileage') return data.finish + ' km, ' + data.from + '‚Üí' + data.to + ', ' + data.wp;
  if (data.type === 'gas') return '$' + data.price + ', ' + data.liters + 'L';
  if (data.type === 'expense') return '$' + data.amount + ' ' + data.category;
  if (data.type === 'allergy') return 'R=' + (data.right || '-') + ', L=' + (data.left || '-');
  return '';
}

function showSuccess(data, isCorrection) {
  var summary = getSummary(data);
  var rowInfo = lastSavedRow ? ' (row ' + lastSavedRow + ')' : '';
  if (isCorrection) {
    updateStatus('‚úÖ Fixed: ' + summary + rowInfo, false, 'success');
  } else {
    updateStatus('‚úÖ ' + summary + rowInfo, false, 'success');
  }
  hideRetryButton();
  showCorrectButton();
  showDeleteButton();
}

function confirmDelete() {
  var desc = getSummary(lastSavedData);
  document.getElementById('deleteDescription').textContent = 'Delete: ' + desc + '?';
  document.getElementById('deletePrompt').classList.add('active');
}

function cancelDelete() {
  document.getElementById('deletePrompt').classList.remove('active');
}

async function executeDelete() {
  document.getElementById('deletePrompt').classList.remove('active');
  updateStatus('Delete not yet implemented for Excel. Please delete manually.', false, 'warning');
  // Note: Deleting rows from Excel via Graph API is complex - would need to clear the row or shift rows
}

function retryLastSubmit() {
  if (lastSubmitData) {
    submitAttempts = 0;
    submitData(lastSubmitData.data, lastSubmitData.isCorrection);
  }
}

function showCorrectForm() {
  var html = '';
  var title = '';

  if (lastSavedData.type === 'mileage') {
    title = 'Edit Mileage';
    html = '<div class="edit-field"><label>Date</label><input type="date" id="editDate" value="' + lastSavedData.date + '"></div>';
    html += '<div class="edit-field"><label>Odometer</label><input type="number" id="editOdometer" value="' + lastSavedData.finish + '"></div>';
    html += '<div class="edit-field"><label>From</label><input type="text" id="editFrom" value="' + lastSavedData.from + '"></div>';
    html += '<div class="edit-field"><label>To</label><input type="text" id="editTo" value="' + lastSavedData.to + '"></div>';
    html += '<div class="edit-field"><label>Work/Personal</label><select id="editWP"><option value="Work"' + (lastSavedData.wp === 'Work' ? ' selected' : '') + '>Work</option><option value="Personal"' + (lastSavedData.wp === 'Personal' ? ' selected' : '') + '>Personal</option></select></div>';
    html += '<div class="edit-field"><label>Description</label><input type="text" id="editDescription" value="' + (lastSavedData.description || '') + '"></div>';
  }
  else if (lastSavedData.type === 'gas') {
    title = 'Edit Gas';
    html = '<div class="edit-field"><label>Date</label><input type="date" id="editDate" value="' + lastSavedData.date + '"></div>';
    html += '<div class="edit-field"><label>Odometer</label><input type="number" id="editOdometer" value="' + lastSavedData.odometer + '"></div>';
    html += '<div class="edit-field"><label>Litres</label><input type="number" step="0.1" id="editLiters" value="' + lastSavedData.liters + '"></div>';
    html += '<div class="edit-field"><label>Price ($)</label><input type="number" step="0.01" id="editPrice" value="' + lastSavedData.price + '"></div>';
  }
  else if (lastSavedData.type === 'expense') {
    title = 'Edit Expense';
    html = '<div class="edit-field"><label>Date</label><input type="date" id="editDate" value="' + lastSavedData.date + '"></div>';
    html += '<div class="edit-field"><label>Amount ($)</label><input type="number" step="0.01" id="editAmount" value="' + lastSavedData.amount + '"></div>';
    html += '<div class="edit-field"><label>Vendor</label><input type="text" id="editVendor" value="' + (lastSavedData.vendor || '') + '"></div>';
    html += '<div class="edit-field"><label>Category</label><select id="editCategory">';
    for (var i = 0; i < allCategories.length; i++) {
      html += '<option value="' + allCategories[i] + '"' + (lastSavedData.category === allCategories[i] ? ' selected' : '') + '>' + allCategories[i] + '</option>';
    }
    html += '</select></div>';
    html += '<div class="edit-field"><label>Corp/Personal</label><select id="editCorpPersonal"><option value="Corp"' + (lastSavedData.corpPersonal === 'Corp' ? ' selected' : '') + '>Corp</option><option value="Personal"' + (lastSavedData.corpPersonal === 'Personal' ? ' selected' : '') + '>Personal</option></select></div>';
    html += '<div class="edit-field"><label>Description</label><input type="text" id="editExpenseDescription" value="' + (lastSavedData.description || '') + '"></div>';
  }
  else if (lastSavedData.type === 'allergy') {
    title = 'Edit Allergy';
    html = '<div class="edit-field"><label>Date</label><input type="date" id="editDate" value="' + lastSavedData.date + '"></div>';
    html += '<div class="edit-field"><label>Right</label><input type="number" step="0.05" id="editRight" value="' + (lastSavedData.right || '') + '"></div>';
    html += '<div class="edit-field"><label>Left</label><input type="number" step="0.05" id="editLeft" value="' + (lastSavedData.left || '') + '"></div>';
    html += '<div class="edit-field"><label>Notes</label><input type="text" id="editNotes" value="' + (lastSavedData.notes || '') + '"></div>';
  }

  document.getElementById('editTitle').textContent = title;
  document.getElementById('editFields').innerHTML = html;
  document.getElementById('editPrompt').classList.add('active');
}

function saveCorrection() {
  var correctedData = { type: lastSavedData.type };

  if (lastSavedData.type === 'mileage') {
    correctedData.date = document.getElementById('editDate').value;
    correctedData.finish = parseInt(document.getElementById('editOdometer').value);
    correctedData.from = document.getElementById('editFrom').value;
    correctedData.to = document.getElementById('editTo').value;
    correctedData.wp = document.getElementById('editWP').value;
    correctedData.description = document.getElementById('editDescription').value;
  }
  else if (lastSavedData.type === 'gas') {
    correctedData.date = document.getElementById('editDate').value;
    correctedData.odometer = parseInt(document.getElementById('editOdometer').value);
    correctedData.liters = parseFloat(document.getElementById('editLiters').value);
    correctedData.price = parseFloat(document.getElementById('editPrice').value);
  }
  else if (lastSavedData.type === 'expense') {
    correctedData.date = document.getElementById('editDate').value;
    correctedData.amount = parseFloat(document.getElementById('editAmount').value);
    correctedData.vendor = document.getElementById('editVendor').value;
    correctedData.category = document.getElementById('editCategory').value;
    correctedData.corpPersonal = document.getElementById('editCorpPersonal').value;
    correctedData.paidOn = (correctedData.corpPersonal === 'Corp') ? 'Corp Card' : 'Personal Card';
    correctedData.description = document.getElementById('editExpenseDescription').value;
  }
  else if (lastSavedData.type === 'allergy') {
    correctedData.date = document.getElementById('editDate').value;
    correctedData.right = parseFloat(document.getElementById('editRight').value) || null;
    correctedData.left = parseFloat(document.getElementById('editLeft').value) || null;
    correctedData.notes = document.getElementById('editNotes').value;
  }

  document.getElementById('editPrompt').classList.remove('active');
  submitData(correctedData, true);
}

function cancelCorrection() {
  document.getElementById('editPrompt').classList.remove('active');
}
</script>

</body>
</html>
